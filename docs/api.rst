.. _api:
============
SPWorlds API
============

Получение токена и ID карты
===========================

Для использования API вам надо знать ID и token для карты, с которой вы
хотите совершить действие. Получить их можно в секции “Поделиться
картой” на сайте.

Выполнение запросов
===================

Все запросы к SPWorlds API должны обслуживаться через HTTPS и должны быть предоставлены в слудующей форме:

.. code::

  https://spworlds.ru/api/public/card


Поддерживаются **GET** и **POST** методы. Направляя любые запросы к API, добавляйте header ``Authorization`` имеющий
форму ``Bearer key``

.. hint::

  Где ``key`` - base64 закодированная строка ``ID:TOKEN``, где ``ID`` - ID вашей карты, ``TOKEN`` - token от нее.
  
Оплата
======

Создание запроса на оплату
--------------------------

Чтобы принять оплату АРами, надо сначала создать запрос на оплату. Он
делается таким **POST** запросом

.. code::

   https://spworlds.ru/api/public/payment

.. table:: В теле запроса должен быть JSON-объект, содержащий:

  ===============   ====================================================================================
  ``amount``        Стоимость покупки в АРах
  ``redirectUrl``   URL страницы, на которую попадет пользователь после оплаты
  ``webhookUrl``    URL, куда наш сервер направит запрос, чтобы оповестить ваш сервер об успешной оплате
  ``data``          Строка до 100 символов, сюда можно поместить любые полезные данные
  ===============   ====================================================================================
  
.. attention:: 

  .. table:: Ответ будет в формате JSON и будет содержать только:
  
    =======   =======================================================================
    ``url``   Ссылка на страницу оплаты, на которую стоит перенаправить пользователя.
    =======   =======================================================================

Получение данных об успешной оплате
-----------------------------------

После успешной оплаты наш сервер указанный в ``webhookUrl`` отправит **POST** запрос по URL, который вы
указали при создании запроса на оплату (webhookUrl).

Тело запроса будет в формате JSON:

-  ``payer`` - Ник игрока, который совершил оплату
-  ``amount`` - Стоимость покупки
-  ``data`` - Данные, которые вы отдали при создании запроса на оплату

**Важно!** При обработке этого запроса надо подтвердить, что данные
пришли из нашего сервера. Для этого в хедерах запроса есть хедер
``X-Body-Hash`` который содержит закодированный в base64 SHA256
`HMAC <https://ru.wikipedia.org/wiki/HMAC>`__ хеш тела запроса,
использующий как ключ api токен вашей карты. При приеме запроса вы
сначала должны сгенерировать свой хеш и убедиться что он совпадает с
хедером, прежде чем обрабатывать запрос.
